<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cotizaciones y Ventas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 100%;
        }

        .login-box h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        /* Main App */
        #app {
            display: none;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .app-header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .company-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .company-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 5px;
        }

        .company-details h2 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .company-details p {
            color: #7f8c8d;
            font-style: italic;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .quote-number {
            background: #ecf0f1;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        /* Main Content */
        .main-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: #3498db;
            border-radius: 2px;
        }

        /* Selection Area */
        .selection-area {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .selection-area .form-group {
            flex: 1;
            min-width: 300px;
            margin-bottom: 0;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        select:focus {
            outline: none;
            border-color: #3498db;
        }

        .valid-selection {
            background-color: #d4edda !important;
            border-color: #27ae60 !important;
        }

        /* Product Table */
        .product-input-area {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .products-table th {
            background: #3498db;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
        }

        .products-table td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
        }

        .products-table tr:hover {
            background: #f8f9fa;
        }

        .product-image {
            width: 25px;
            height: 25px;
            object-fit: cover;
            border-radius: 4px;
        }

        /* Totals Section */
        .totals-section {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            margin-left: auto;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 16px;
        }

        .total-row.grand-total {
            border-top: 2px solid #2c3e50;
            margin-top: 10px;
            padding-top: 15px;
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }

        /* Terms Section */
        .terms-area {
            margin-top: 20px;
        }

        .terms-area textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .terms-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-header h3 {
            color: #2c3e50;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: flex-end;
        }

        .file-input-label {
            display: inline-block;
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: #2980b9;
        }

        input[type="file"] {
            display: none;
        }

        /* Autocomplete */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .autocomplete-list.active {
            display: block;
        }

        .autocomplete-item {
            padding: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .autocomplete-item:hover {
            background: #ecf0f1;
        }

        /* Type Toggle */
        .type-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .type-toggle .btn {
            flex: 1;
        }

        .type-toggle .btn.active {
            background: #2c3e50;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .product-input-area {
                grid-template-columns: 1fr;
            }

            .terms-list {
                grid-template-columns: 1fr;
            }

            .selection-area {
                flex-direction: column;
            }

            .selection-area .form-group {
                width: 100%;
            }
        }

        .error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
        }

        .hidden {
            display: none !important;
        }

        /* Delete button for table rows */
        .btn-delete {
            background: transparent;
            color: #e74c3c;
            border: 1px solid #e74c3c;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-delete:hover {
            background: #e74c3c;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>Sistema de Cotizaciones</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usuario</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Contrase帽a</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Iniciar Sesi贸n</button>
                <div id="loginError" class="error-message hidden"></div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app">
        <!-- Header -->
        <div class="app-header">
            <div class="company-info">
                <img id="companyLogo" class="company-logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect fill='%23ecf0f1' width='100' height='100'/%3E%3Ctext x='50%25' y='50%25' font-size='14' text-anchor='middle' dy='.3em' fill='%237f8c8d'%3ELOGO%3C/text%3E%3C/svg%3E" alt="Logo">
                <div class="company-details">
                    <h2 id="companyName">Nombre de la Empresa</h2>
                    <p id="companySlogan">Eslogan de la empresa</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openCompanySettings()">锔 Configuraci贸n</button>
                <div class="quote-number">
                    <span id="quoteNumber">N潞 100000</span>
                </div>
                <button class="btn btn-danger" onclick="logout()">Salir</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Document Type Toggle -->
            <div class="type-toggle">
                <button class="btn btn-primary active" onclick="setDocumentType('cotizacion')">Cotizaci贸n</button>
                <button class="btn btn-primary" onclick="setDocumentType('notaventa')">Nota de Venta</button>
            </div>

            <!-- Client Section -->
            <div class="section">
                <h3 class="section-title">Datos del Cliente</h3>
                <div class="selection-area">
                    <div class="form-group">
                        <label for="clientSelect">Cliente</label>
                        <div class="autocomplete-container">
                            <input type="text" id="clientSelect" class="autocomplete-input" placeholder="Buscar o seleccionar cliente..." oninput="filterClients(this.value)" onfocus="showClientList()">
                            <div id="clientList" class="autocomplete-list"></div>
                        </div>
                    </div>
                    <button class="btn btn-success" id="clientActionBtn" onclick="handleClientAction()">Agregar Cliente</button>
                </div>
            </div>

            <!-- Seller Section -->
            <div class="section">
                <h3 class="section-title">Datos del Vendedor</h3>
                <div class="selection-area">
                    <div class="form-group">
                        <label for="sellerSelect">Vendedor</label>
                        <div class="autocomplete-container">
                            <input type="text" id="sellerSelect" class="autocomplete-input" placeholder="Buscar o seleccionar vendedor..." oninput="filterSellers(this.value)" onfocus="showSellerList()">
                            <div id="sellerList" class="autocomplete-list"></div>
                        </div>
                    </div>
                    <button class="btn btn-success" id="sellerActionBtn" onclick="handleSellerAction()">Agregar Vendedor</button>
                </div>
            </div>

            <!-- Products Section -->
            <div class="section">
                <h3 class="section-title">Productos</h3>
                <div class="product-input-area">
                    <div class="form-group">
                        <label for="productSelect">Producto</label>
                        <div class="autocomplete-container">
                            <input type="text" id="productSelect" class="autocomplete-input" placeholder="Buscar producto..." oninput="filterProducts(this.value)" onfocus="showProductList()">
                            <div id="productList" class="autocomplete-list"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="productQuantity">Cantidad</label>
                        <input type="number" id="productQuantity" min="1" value="1" oninput="updateProductPreview()">
                    </div>
                    <div class="form-group">
                        <label for="productDiscount">Descuento</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="number" id="productDiscount" min="0" value="0" oninput="updateProductPreview()">
                            <select id="discountType" onchange="updateProductPreview()">
                                <option value="%">%</option>
                                <option value="Bs">Bs</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Precio Unit.</label>
                        <input type="number" id="productPrice" min="0" step="0.01" value="0" oninput="updateProductPreview()">
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="addProductToQuote()">Agregar a Cotizaci贸n</button>
                    <button class="btn btn-warning" id="productActionBtn" onclick="handleProductAction()">Nuevo Producto</button>
                </div>

                <table class="products-table" id="productsTable">
                    <thead>
                        <tr>
                            <th>Img</th>
                            <th>#</th>
                            <th>C贸digo</th>
                            <th>Descripci贸n</th>
                            <th>Cantidad</th>
                            <th>Precio Unit.</th>
                            <th>Descuento</th>
                            <th>Subtotal</th>
                            <th>Acci贸n</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <!-- Products will be added here -->
                    </tbody>
                </table>
            </div>

            <!-- Totals Section -->
            <div class="totals-section">
                <div class="total-row">
                    <span>Subtotal:</span>
                    <span id="subtotalAmount">Bs 0.00</span>
                </div>
                <div class="total-row">
                    <span>Descuento Total:</span>
                    <span id="discountAmount">Bs 0.00</span>
                </div>
                <div class="total-row grand-total">
                    <span>TOTAL:</span>
                    <span id="totalAmount">Bs 0.00</span>
                </div>
            </div>

            <!-- Terms and Conditions -->
            <div class="section terms-area">
                <h3 class="section-title">T茅rminos y Condiciones</h3>
                <div class="terms-list">
                    <div class="form-group">
                        <label>T茅rmino 1</label>
                        <textarea id="term1"></textarea>
                    </div>
                    <div class="form-group">
                        <label>T茅rmino 2</label>
                        <textarea id="term2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>T茅rmino 3</label>
                        <textarea id="term3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>T茅rmino 4</label>
                        <textarea id="term4"></textarea>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="newQuote()">Nueva Cotizaci贸n</button>
                <button class="btn btn-primary" onclick="generatePDF()">Generar PDF</button>
            </div>
        </div>
    </div>

    <!-- Company Settings Modal -->
    <div id="companyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Configuraci贸n de la Empresa</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nombre de la Empresa</label>
                    <input type="text" id="modalCompanyName">
                </div>
                <div class="form-group">
                    <label>Eslogan</label>
                    <input type="text" id="modalCompanySlogan">
                </div>
                <div class="form-group">
                    <label>Logo</label>
                    <label for="logoInput" class="file-input-label"> Cargar Logo</label>
                    <input type="file" id="logoInput" accept="image/*" onchange="handleLogoUpload(event)">
                    <img id="logoPreview" style="max-width: 200px; margin-top: 10px; display: none;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('companyModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveCompanySettings()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Client Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="clientModalTitle">Agregar Cliente</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nombre *</label>
                    <input type="text" id="modalClientName" required>
                </div>
                <div class="form-group">
                    <label>Tel茅fono</label>
                    <input type="text" id="modalClientPhone">
                </div>
                <div class="form-group">
                    <label>CI/CNIT</label>
                    <input type="text" id="modalClientCI">
                </div>
                <div class="form-group">
                    <label>Empresa</label>
                    <input type="text" id="modalClientCompany">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('clientModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveClient()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Seller Modal -->
    <div id="sellerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="sellerModalTitle">Agregar Vendedor</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nombre *</label>
                    <input type="text" id="modalSellerName" required>
                </div>
                <div class="form-group">
                    <label>Celular</label>
                    <input type="text" id="modalSellerPhone">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('sellerModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveSeller()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">Nuevo Producto</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>C贸digo</label>
                    <input type="text" id="modalProductCode">
                </div>
                <div class="form-group">
                    <label>Descripci贸n *</label>
                    <input type="text" id="modalProductDescription" required>
                </div>
                <div class="form-group">
                    <label>Precio Unitario</label>
                    <input type="number" id="modalProductPrice" min="0" step="0.01" value="0">
                </div>
                <div class="form-group">
                    <label>Imagen del Producto</label>
                    <label for="productImageInput" class="file-input-label"> Cargar Imagen</label>
                    <input type="file" id="productImageInput" accept="image/*" onchange="handleProductImageUpload(event)">
                    <img id="productImagePreview" style="max-width: 200px; margin-top: 10px; display: none;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('productModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveProduct()">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== Data Storage ====================
        let appData = {
            company: {
                name: 'Nombre de la Empresa',
                slogan: 'Eslogan de la empresa',
                logo: ''
            },
            clients: [],
            sellers: [],
            products: [],
            quotes: [],
            currentQuoteNumber: 100000,
            currentClient: null,
            currentSeller: null,
            currentProduct: null,
            currentQuoteItems: [],
            documentType: 'cotizacion',
            terms: {
                cotizacion: [
                    'Precios sujetos a cambio sin previo aviso',
                    'Validez de la cotizaci贸n: 15 d铆as',
                    'Formas de pago: efectivo, transferencia o tarjeta',
                    'Tiempo de entrega: seg煤n disponibilidad'
                ],
                notaventa: [
                    'Producto vendido sin garant铆a',
                    'No se aceptan devoluciones',
                    'Revisi贸n del producto antes de retirarlo',
                    'El cliente acepta el producto en las condiciones presentadas'
                ]
            }
        };

        // ==================== Initialization ====================
        function init() {
            loadData();
            updateUI();
            loadTerms();
        }

        function loadData() {
            const saved = localStorage.getItem('proformaAppData');
            if (saved) {
                const parsed = JSON.parse(saved);
                appData = { ...appData, ...parsed };
            }
        }

        function saveData() {
            localStorage.setItem('proformaAppData', JSON.stringify(appData));
        }

        function updateUI() {
            document.getElementById('companyName').textContent = appData.company.name;
            document.getElementById('companySlogan').textContent = appData.company.slogan;
            if (appData.company.logo) {
                document.getElementById('companyLogo').src = appData.company.logo;
            }
            document.getElementById('quoteNumber').textContent = 'N潞 ' + appData.currentQuoteNumber;
        }

        // ==================== Login ====================
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === 'CiamP25' && password === 'CiamP25') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                init();
            } else {
                const errorDiv = document.getElementById('loginError');
                errorDiv.textContent = 'Usuario o contrase帽a incorrectos';
                errorDiv.classList.remove('hidden');
            }
        });

        function logout() {
            if (confirm('驴Est谩 seguro de cerrar sesi贸n?')) {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('loginError').classList.add('hidden');
            }
        }

        // ==================== Company Settings ====================
        function openCompanySettings() {
            document.getElementById('modalCompanyName').value = appData.company.name;
            document.getElementById('modalCompanySlogan').value = appData.company.slogan;
            if (appData.company.logo) {
                document.getElementById('logoPreview').src = appData.company.logo;
                document.getElementById('logoPreview').style.display = 'block';
            }
            openModal('companyModal');
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('logoPreview').src = e.target.result;
                    document.getElementById('logoPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function saveCompanySettings() {
            appData.company.name = document.getElementById('modalCompanyName').value;
            appData.company.slogan = document.getElementById('modalCompanySlogan').value;
            const logoPreview = document.getElementById('logoPreview');
            if (logoPreview.style.display !== 'none') {
                appData.company.logo = logoPreview.src;
            }
            saveData();
            updateUI();
            closeModal('companyModal');
        }

        // ==================== Document Type ====================
        function setDocumentType(type) {
            appData.documentType = type;
            document.querySelectorAll('.type-toggle .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadTerms();
        }

        function loadTerms() {
            const terms = appData.terms[appData.documentType];
            for (let i = 0; i < 4; i++) {
                document.getElementById('term' + (i + 1)).value = terms[i] || '';
            }
        }

        function saveTerms() {
            const terms = [];
            for (let i = 1; i <= 4; i++) {
                terms.push(document.getElementById('term' + i).value);
            }
            appData.terms[appData.documentType] = terms;
            saveData();
        }

        // ==================== Client Management ====================
        function filterClients(query) {
            const list = document.getElementById('clientList');
            list.innerHTML = '';
            
            if (!query) {
                appData.clients.forEach(client => {
                    addClientToList(client, list);
                });
            } else {
                const filtered = appData.clients.filter(c => 
                    c.name.toLowerCase().includes(query.toLowerCase()) ||
                    (c.company && c.company.toLowerCase().includes(query.toLowerCase()))
                );
                filtered.forEach(client => {
                    addClientToList(client, list);
                });
            }
            
            if (list.children.length > 0) {
                list.classList.add('active');
            }
        }

        function showClientList() {
            filterClients('');
        }

        function addClientToList(client, list) {
            const div = document.createElement('div');
            div.className = 'autocomplete-item';
            div.textContent = client.name + (client.company ? ' - ' + client.company : '');
            div.onclick = () => selectClient(client);
            list.appendChild(div);
        }

        function selectClient(client) {
            appData.currentClient = client;
            const input = document.getElementById('clientSelect');
            input.value = client.name;
            input.classList.add('valid-selection');
            document.getElementById('clientList').classList.remove('active');
            document.getElementById('clientActionBtn').textContent = 'Editar Cliente';
            document.getElementById('clientActionBtn').className = 'btn btn-warning';
        }

        function handleClientAction() {
            if (appData.currentClient) {
                // Edit mode
                document.getElementById('clientModalTitle').textContent = 'Editar Cliente';
                document.getElementById('modalClientName').value = appData.currentClient.name;
                document.getElementById('modalClientPhone').value = appData.currentClient.phone || '';
                document.getElementById('modalClientCI').value = appData.currentClient.ci || '';
                document.getElementById('modalClientCompany').value = appData.currentClient.company || '';
            } else {
                // Add mode
                document.getElementById('clientModalTitle').textContent = 'Agregar Cliente';
                document.getElementById('modalClientName').value = '';
                document.getElementById('modalClientPhone').value = '';
                document.getElementById('modalClientCI').value = '';
                document.getElementById('modalClientCompany').value = '';
            }
            openModal('clientModal');
        }

        function saveClient() {
            const name = document.getElementById('modalClientName').value.trim();
            if (!name) {
                alert('El nombre es obligatorio');
                return;
            }

            const client = {
                id: appData.currentClient ? appData.currentClient.id : Date.now(),
                name: name,
                phone: document.getElementById('modalClientPhone').value,
                ci: document.getElementById('modalClientCI').value,
                company: document.getElementById('modalClientCompany').value
            };

            if (appData.currentClient) {
                // Update existing
                const index = appData.clients.findIndex(c => c.id === appData.currentClient.id);
                appData.clients[index] = client;
            } else {
                // Add new
                appData.clients.push(client);
            }

            appData.currentClient = client;
            saveData();
            selectClient(client);
            closeModal('clientModal');
        }

        // Close autocomplete when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.autocomplete-container')) {
                document.querySelectorAll('.autocomplete-list').forEach(list => {
                    list.classList.remove('active');
                });
            }
        });

        // ==================== Seller Management ====================
        function filterSellers(query) {
            const list = document.getElementById('sellerList');
            list.innerHTML = '';
            
            if (!query) {
                appData.sellers.forEach(seller => {
                    addSellerToList(seller, list);
                });
            } else {
                const filtered = appData.sellers.filter(s => 
                    s.name.toLowerCase().includes(query.toLowerCase())
                );
                filtered.forEach(seller => {
                    addSellerToList(seller, list);
                });
            }
            
            if (list.children.length > 0) {
                list.classList.add('active');
            }
        }

        function showSellerList() {
            filterSellers('');
        }

        function addSellerToList(seller, list) {
            const div = document.createElement('div');
            div.className = 'autocomplete-item';
            div.textContent = seller.name + (seller.phone ? ' - ' + seller.phone : '');
            div.onclick = () => selectSeller(seller);
            list.appendChild(div);
        }

        function selectSeller(seller) {
            appData.currentSeller = seller;
            const input = document.getElementById('sellerSelect');
            input.value = seller.name;
            input.classList.add('valid-selection');
            document.getElementById('sellerList').classList.remove('active');
            document.getElementById('sellerActionBtn').textContent = 'Editar Vendedor';
            document.getElementById('sellerActionBtn').className = 'btn btn-warning';
        }

        function handleSellerAction() {
            if (appData.currentSeller) {
                document.getElementById('sellerModalTitle').textContent = 'Editar Vendedor';
                document.getElementById('modalSellerName').value = appData.currentSeller.name;
                document.getElementById('modalSellerPhone').value = appData.currentSeller.phone || '';
            } else {
                document.getElementById('sellerModalTitle').textContent = 'Agregar Vendedor';
                document.getElementById('modalSellerName').value = '';
                document.getElementById('modalSellerPhone').value = '';
            }
            openModal('sellerModal');
        }

        function saveSeller() {
            const name = document.getElementById('modalSellerName').value.trim();
            if (!name) {
                alert('El nombre es obligatorio');
                return;
            }

            const seller = {
                id: appData.currentSeller ? appData.currentSeller.id : Date.now(),
                name: name,
                phone: document.getElementById('modalSellerPhone').value
            };

            if (appData.currentSeller) {
                const index = appData.sellers.findIndex(s => s.id === appData.currentSeller.id);
                appData.sellers[index] = seller;
            } else {
                appData.sellers.push(seller);
            }

            appData.currentSeller = seller;
            saveData();
            selectSeller(seller);
            closeModal('sellerModal');
        }

        // ==================== Product Management ====================
        function filterProducts(query) {
            const list = document.getElementById('productList');
            list.innerHTML = '';
            
            if (!query) {
                appData.products.forEach(product => {
                    addProductToList(product, list);
                });
            } else {
                const filtered = appData.products.filter(p => 
                    p.description.toLowerCase().includes(query.toLowerCase()) ||
                    (p.code && p.code.toLowerCase().includes(query.toLowerCase()))
                );
                filtered.forEach(product => {
                    addProductToList(product, list);
                });
            }
            
            if (list.children.length > 0) {
                list.classList.add('active');
            }
        }

        function showProductList() {
            filterProducts('');
        }

        function addProductToList(product, list) {
            const div = document.createElement('div');
            div.className = 'autocomplete-item';
            div.textContent = (product.code ? product.code + ' - ' : '') + product.description;
            div.onclick = () => selectProduct(product);
            list.appendChild(div);
        }

        function selectProduct(product) {
            appData.currentProduct = product;
            const input = document.getElementById('productSelect');
            input.value = product.description;
            input.classList.add('valid-selection');
            document.getElementById('productList').classList.remove('active');
            document.getElementById('productPrice').value = product.price || 0;
            document.getElementById('productActionBtn').textContent = 'Modificar Producto';
            document.getElementById('productActionBtn').className = 'btn btn-warning';
            updateProductPreview();
        }

        function handleProductAction() {
            if (appData.currentProduct) {
                document.getElementById('productModalTitle').textContent = 'Modificar Producto';
                document.getElementById('modalProductCode').value = appData.currentProduct.code || '';
                document.getElementById('modalProductDescription').value = appData.currentProduct.description;
                document.getElementById('modalProductPrice').value = appData.currentProduct.price || 0;
                if (appData.currentProduct.image) {
                    document.getElementById('productImagePreview').src = appData.currentProduct.image;
                    document.getElementById('productImagePreview').style.display = 'block';
                }
            } else {
                document.getElementById('productModalTitle').textContent = 'Nuevo Producto';
                document.getElementById('modalProductCode').value = '';
                document.getElementById('modalProductDescription').value = '';
                document.getElementById('modalProductPrice').value = 0;
                document.getElementById('productImagePreview').style.display = 'none';
            }
            openModal('productModal');
        }

        function handleProductImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('productImagePreview').src = e.target.result;
                    document.getElementById('productImagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function saveProduct() {
            const description = document.getElementById('modalProductDescription').value.trim();
            if (!description) {
                alert('La descripci贸n es obligatoria');
                return;
            }

            const product = {
                id: appData.currentProduct ? appData.currentProduct.id : Date.now(),
                code: document.getElementById('modalProductCode').value,
                description: description,
                price: parseFloat(document.getElementById('modalProductPrice').value) || 0,
                registrationDate: appData.currentProduct ? appData.currentProduct.registrationDate : new Date().toISOString(),
                image: ''
            };

            const imgPreview = document.getElementById('productImagePreview');
            if (imgPreview.style.display !== 'none') {
                product.image = imgPreview.src;
            }

            if (appData.currentProduct) {
                const index = appData.products.findIndex(p => p.id === appData.currentProduct.id);
                appData.products[index] = product;
            } else {
                appData.products.push(product);
            }

            appData.currentProduct = product;
            saveData();
            selectProduct(product);
            closeModal('productModal');
        }

        function updateProductPreview() {
            // Just for visual feedback
        }

        function addProductToQuote() {
            if (!appData.currentProduct) {
                alert('Seleccione un producto');
                return;
            }

            const quantity = parseFloat(document.getElementById('productQuantity').value) || 1;
            const price = parseFloat(document.getElementById('productPrice').value) || 0;
            const discount = parseFloat(document.getElementById('productDiscount').value) || 0;
            const discountType = document.getElementById('discountType').value;

            let discountAmount = 0;
            if (discountType === '%') {
                discountAmount = (price * quantity * discount) / 100;
            } else {
                discountAmount = discount;
            }

            const subtotal = (price * quantity) - discountAmount;

            const item = {
                id: Date.now(),
                product: appData.currentProduct,
                quantity: quantity,
                price: price,
                discount: discount,
                discountType: discountType,
                discountAmount: discountAmount,
                subtotal: subtotal
            };

            appData.currentQuoteItems.push(item);
            renderQuoteItems();
            calculateTotals();

            // Reset form
            document.getElementById('productSelect').value = '';
            document.getElementById('productSelect').classList.remove('valid-selection');
            document.getElementById('productQuantity').value = 1;
            document.getElementById('productDiscount').value = 0;
            document.getElementById('productPrice').value = 0;
            appData.currentProduct = null;
            document.getElementById('productActionBtn').textContent = 'Nuevo Producto';
            document.getElementById('productActionBtn').className = 'btn btn-warning';
        }

        function renderQuoteItems() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';

            appData.currentQuoteItems.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><img src="${item.product.image || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'25\' height=\'25\'%3E%3Crect fill=\'%23ecf0f1\' width=\'25\' height=\'25\'/%3E%3C/svg%3E'}" class="product-image" alt=""></td>
                    <td>${index + 1}</td>
                    <td>${item.product.code || '-'}</td>
                    <td>${item.product.description}</td>
                    <td>${item.quantity}</td>
                    <td>Bs ${item.price.toFixed(2)}</td>
                    <td>${item.discount} ${item.discountType}</td>
                    <td>Bs ${item.subtotal.toFixed(2)}</td>
                    <td><button class="btn btn-delete" onclick="removeQuoteItem(${item.id})">Eliminar</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function removeQuoteItem(itemId) {
            appData.currentQuoteItems = appData.currentQuoteItems.filter(item => item.id !== itemId);
            renderQuoteItems();
            calculateTotals();
        }

        function calculateTotals() {
            let subtotal = 0;
            let totalDiscount = 0;

            appData.currentQuoteItems.forEach(item => {
                subtotal += item.price * item.quantity;
                totalDiscount += item.discountAmount;
            });

            const total = subtotal - totalDiscount;

            document.getElementById('subtotalAmount').textContent = 'Bs ' + subtotal.toFixed(2);
            document.getElementById('discountAmount').textContent = 'Bs ' + totalDiscount.toFixed(2);
            document.getElementById('totalAmount').textContent = 'Bs ' + total.toFixed(2);
        }

        // ==================== PDF Generation ====================
        function generatePDF() {
            if (!appData.currentClient) {
                alert('Debe seleccionar un cliente');
                return;
            }
            if (!appData.currentSeller) {
                alert('Debe seleccionar un vendedor');
                return;
            }
            if (appData.currentQuoteItems.length === 0) {
                alert('Debe agregar al menos un producto');
                return;
            }

            saveTerms();

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 15;
            let yPos = margin;

            // Header
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text(appData.company.name, margin, yPos);
            yPos += 7;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'italic');
            doc.text(appData.company.slogan, margin, yPos);
            yPos += 10;

            // Document type and number
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            const docTitle = appData.documentType === 'cotizacion' ? 'COTIZACIN' : 'NOTA DE VENTA';
            doc.text(docTitle, pageWidth - margin, 15, { align: 'right' });
            doc.setFontSize(12);
            doc.text('N潞 ' + appData.currentQuoteNumber, pageWidth - margin, 22, { align: 'right' });
            
            doc.setFontSize(10);
            doc.text('Fecha: ' + new Date().toLocaleDateString('es-BO'), pageWidth - margin, 29, { align: 'right' });

            // Line separator
            doc.setLineWidth(0.5);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 8;

            // Client info
            doc.setFont(undefined, 'bold');
            doc.text('CLIENTE:', margin, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(appData.currentClient.name, margin + 25, yPos);
            yPos += 6;

            if (appData.currentClient.company) {
                doc.setFont(undefined, 'bold');
                doc.text('Empresa:', margin, yPos);
                doc.setFont(undefined, 'normal');
                doc.text(appData.currentClient.company, margin + 25, yPos);
                yPos += 6;
            }

            if (appData.currentClient.ci) {
                doc.setFont(undefined, 'bold');
                doc.text('CI/CNIT:', margin, yPos);
                doc.setFont(undefined, 'normal');
                doc.text(appData.currentClient.ci, margin + 25, yPos);
                yPos += 6;
            }

            if (appData.currentClient.phone) {
                doc.setFont(undefined, 'bold');
                doc.text('Tel茅fono:', margin, yPos);
                doc.setFont(undefined, 'normal');
                doc.text(appData.currentClient.phone, margin + 25, yPos);
                yPos += 6;
            }

            yPos += 3;

            // Seller info
            doc.setFont(undefined, 'bold');
            doc.text('VENDEDOR:', margin, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(appData.currentSeller.name, margin + 25, yPos);
            
            if (appData.currentSeller.phone) {
                doc.text('Tel: ' + appData.currentSeller.phone, margin + 80, yPos);
            }
            yPos += 8;

            // Products table
            doc.setFont(undefined, 'bold');
            doc.setFillColor(52, 152, 219);
            doc.rect(margin, yPos, pageWidth - 2 * margin, 7, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.text('#', margin + 2, yPos + 5);
            doc.text('C贸digo', margin + 10, yPos + 5);
            doc.text('Descripci贸n', margin + 35, yPos + 5);
            doc.text('Cant.', margin + 95, yPos + 5);
            doc.text('P.Unit.', margin + 115, yPos + 5);
            doc.text('Desc.', margin + 140, yPos + 5);
            doc.text('Subtotal', margin + 165, yPos + 5);
            
            yPos += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');

            appData.currentQuoteItems.forEach((item, index) => {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = margin;
                }

                doc.text((index + 1).toString(), margin + 2, yPos);
                doc.text(item.product.code || '-', margin + 10, yPos);
                
                const description = doc.splitTextToSize(item.product.description, 55);
                doc.text(description, margin + 35, yPos);
                
                doc.text(item.quantity.toString(), margin + 95, yPos);
                doc.text('Bs ' + item.price.toFixed(2), margin + 115, yPos);
                doc.text(item.discount + ' ' + item.discountType, margin + 140, yPos);
                doc.text('Bs ' + item.subtotal.toFixed(2), margin + 165, yPos);
                
                yPos += Math.max(7, description.length * 5);
            });

            yPos += 5;
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 8;

            // Totals
            const subtotal = appData.currentQuoteItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const totalDiscount = appData.currentQuoteItems.reduce((sum, item) => sum + item.discountAmount, 0);
            const total = subtotal - totalDiscount;

            const totalsX = pageWidth - margin - 60;
            doc.setFont(undefined, 'normal');
            doc.text('Subtotal:', totalsX, yPos);
            doc.text('Bs ' + subtotal.toFixed(2), totalsX + 40, yPos, { align: 'right' });
            yPos += 6;

            doc.text('Descuento:', totalsX, yPos);
            doc.text('Bs ' + totalDiscount.toFixed(2), totalsX + 40, yPos, { align: 'right' });
            yPos += 8;

            doc.setFont(undefined, 'bold');
            doc.setFontSize(12);
            doc.text('TOTAL:', totalsX, yPos);
            doc.text('Bs ' + total.toFixed(2), totalsX + 40, yPos, { align: 'right' });
            yPos += 10;

            // Terms and conditions
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('T茅rminos y Condiciones:', margin, yPos);
            yPos += 6;

            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            const terms = appData.terms[appData.documentType];
            terms.forEach((term, index) => {
                if (term.trim()) {
                    const termText = `${index + 1}. ${term}`;
                    const lines = doc.splitTextToSize(termText, pageWidth - 2 * margin);
                    lines.forEach(line => {
                        if (yPos > pageHeight - 20) {
                            doc.addPage();
                            yPos = margin;
                        }
                        doc.text(line, margin, yPos);
                        yPos += 5;
                    });
                }
            });

            // Page numbers
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`P谩gina ${i} de ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
            }

            // Save PDF
            const fileName = `${docTitle}_${appData.currentQuoteNumber}_${appData.currentClient.name.replace(/\s+/g, '_')}.pdf`;
            doc.save(fileName);

            // Increment quote number
            appData.currentQuoteNumber++;
            saveData();
            updateUI();
        }

        // ==================== Utility Functions ====================
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function newQuote() {
            if (confirm('驴Desea crear una nueva cotizaci贸n? Se perder谩n los datos actuales no guardados.')) {
                appData.currentClient = null;
                appData.currentSeller = null;
                appData.currentProduct = null;
                appData.currentQuoteItems = [];

                document.getElementById('clientSelect').value = '';
                document.getElementById('clientSelect').classList.remove('valid-selection');
                document.getElementById('clientActionBtn').textContent = 'Agregar Cliente';
                document.getElementById('clientActionBtn').className = 'btn btn-success';

                document.getElementById('sellerSelect').value = '';
                document.getElementById('sellerSelect').classList.remove('valid-selection');
                document.getElementById('sellerActionBtn').textContent = 'Agregar Vendedor';
                document.getElementById('sellerActionBtn').className = 'btn btn-success';

                document.getElementById('productSelect').value = '';
                document.getElementById('productSelect').classList.remove('valid-selection');
                document.getElementById('productQuantity').value = 1;
                document.getElementById('productDiscount').value = 0;
                document.getElementById('productPrice').value = 0;
                document.getElementById('productActionBtn').textContent = 'Nuevo Producto';
                document.getElementById('productActionBtn').className = 'btn btn-warning';

                renderQuoteItems();
                calculateTotals();
            }
        }
    </script>
</body>
</html>
